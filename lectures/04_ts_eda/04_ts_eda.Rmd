---
title: "ISA 444: Business Forecasting"
subtitle: '04: Time Series EDA'
author: '<br>Fadel M. Megahed, PhD <br><br> Endres Associate Professor <br> Farmer School of Business<br> Miami University<br><br> [`r icons::icon_style(icons::fontawesome("twitter"), fill = "white")` @FadelMegahed](https://twitter.com/FadelMegahed) <br> [`r icons::icon_style(icons::fontawesome("github"), fill = "white")` fmegahed](https://github.com/fmegahed/) <br> [`r icons::icon_style(icons::fontawesome("paper-plane", style = "solid"), fill = "white")` fmegahed@miamioh.edu](mailto:fmegahed@miamioh.edu)<br> [`r icons::icon_style(icons::fontawesome("question"), fill = "white")` Automated Scheduler for Office Hours](https://calendly.com/fmegahed)<br><br>'
date: "Fall 2023"
output:
  xaringan::moon_reader:
    self_contained: true
    css: [default, "../../style_files/fonts.css", "../../style_files/my-theme.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      highlightLanguage: ["r"]
      countIncrementalSlides: false
      ratio: "16:9"
header-includes:  
  - "../../style_files/header.html"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      progress = FALSE, 
                      verbose = FALSE,
                      dev = 'png',
                      dpi = 300,
                      fig.asp = 0.618,
                      fig.align = 'center',
                      out.width = '70%')

options(htmltools.dir.version = FALSE)


miamired = '#C3142D'

if(require(pacman)==FALSE) install.packages("pacman")
if(require(devtools)==FALSE) install.packages("devtools")
if(require(countdown)==FALSE) devtools::install_github("gadenbuie/countdown")
if(require(xaringanExtra)==FALSE) devtools::install_github("gadenbuie/xaringanExtra")
if(require(emo)==FALSE) devtools::install_github("hadley/emo")
if(require(icons)==FALSE) devtools::install_github("mitchelloharawild/icons")

pacman::p_load(gifski, av, gganimate, ggtext, glue, extrafont, # for animations
               emojifont, emo, RefManageR, xaringanExtra, countdown, downlit) # for slides
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
if(require(xaringanthemer) == FALSE) install.packages("xaringanthemer")
library(xaringanthemer)

style_mono_accent(base_color = "#84d6d3",
                  base_font_size = "20px")

xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)

xaringanExtra::use_xaringan_extra(c("tile_view", "animate_css", "tachyons", "panelset", "share_again", "search", "fit_screen", "editable", "clipboard"))

```


# Quick Refresher from Last Class

`r emo::ji("check")` Read CSV files in both `r fontawesome::fa(name = "r-project", fill = miamired)` and `r fontawesome::fa(name = "python", fill = miamired)`.  

`r emo::ji("check")` Construct line charts and seasonality plots in both `r fontawesome::fa(name = "r-project", fill = miamired)` and `r fontawesome::fa(name = "python", fill = miamired)`. 

`r emo::ji("check")` Utilize the project workflow in `r fontawesome::fa(name = "r-project")` and create `r fontawesome::fa(name = "r-project", fill = miamired)` and `r fontawesome::fa(name = "python", fill = miamired)` scripts.     

`r emo::ji("x")` Access, subset, and create `ts()` objects in `r fontawesome::fa(name = "r-project")`. 



---

# Learning Objectives for Today's Class

- Examine the goals of utilizing line charts in time-series analysis (i.e., detect trends, seasonality, and cycles).  

- Develop a deeper understanding of the grammar of graphics, which we used to create time series plots in `r fontawesome::fa(name = "r-project", fill = miamired)` and `r fontawesome::fa(name = "python", fill = miamired)`.  
- Use numerical summaries to describe a time series.  

- Explain what do we mean by correlation.  



---
class: inverse, center, middle

# A Taxonomy of Time Series Plots and their Interpretation


---

# A Structured Approach for Time Series Viz

```{r run_latex_file, echo=FALSE, cache=TRUE, results='hide'}
tinytex::xelatex('../../figures/ts_plots.tex')
Sys.sleep(2)
pdftools::pdf_convert('../../figures/ts_plots.pdf', dpi = 600,
                      filenames = '../../figures/ts_plots.png')
Sys.sleep(2)
```

```{r read_ts_taxonomy, echo=FALSE, out.width='100%', fig.alt="A Potential Framework for Time Series Visualization", fig.align='center', fig.cap='A Potential Framework for Time Series Visualization'}
knitr::include_graphics("../../figures/ts_plots.png")
```

.footnote[
<html>
<hr>
</html>

This is my best attempt to improve on the general advice provided in the previous slide. Many of the suggestions, presented in this flow chart, stem from my past and current research/consulting collaborations.

They are by no means a comprehensive list of everything that you can do.
]


---

# The Line Chart

```{r cincy_weather, include=FALSE}
cincy_df = readr::read_csv('../../data/cincy_monthly_weather.csv') |> 
  tidyr::pivot_longer(cols = 2:13, names_to = 'month', values_to = 'temp') |> 
  dplyr::mutate(date = paste(year, month, '01', sep = '-') |> 
                  lubridate::ymd(),
                month = lubridate::month(date, label = T))

cincy_df |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = temp)) +
  ggplot2::geom_point(ggplot2::aes(color = month)) +
  ggplot2::geom_line() +
  ggplot2::scale_x_date( breaks = scales::pretty_breaks(n=6) ) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=5)
  ) +
  ggplot2::scale_color_brewer(palette = 'Paired') +
  ggplot2::labs(
    x = "Date", 
    y = "Monthly Temperature") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank(),
                  legend.position = 'bottom',
                  legend.margin=ggplot2::margin(0,0,0,0),
                  legend.box.margin=ggplot2::margin(-10,-10,-10,-10)) +
  ggplot2::guides(colour = ggplot2::guide_legend(nrow = 2)) -> cincy_plot
```


.pull-left[
```{r cincyplot1, out.width='100%', echo = FALSE, fig.cap='A plot of a long time-series for monthly weather in Cincinnati, with color denoting different months.'}
cincy_plot
```
]

.pull-right[
```{r cincyplot2, out.width='100%', echo=FALSE, fig.cap='A snippet of the time-series (last 5 full years) for monthly weather in Cincinnati, with color denoting different months.'}
cincy_plot + 
  tidyquant::coord_x_date(xlim = c(Sys.Date() -lubridate::years(5), Sys.Date()))
```
]


---

# The Line Chart: Practical Considerations

.can-edit.key-activity0_[

**Things to Consider:** .font70[(Insert below)]

  - **Format your data:** ....
  
  - **Entire time-series vs a snippet:** .... 
  
  - **On the use of color:** ....
  
  - **On grouping the data:** ....
]


---

# On the Interpretation of Line Charts

`r countdown(minutes = 5, seconds = 0, top = 0, font_size = "2em")`

.panelset[

.panel[.panel-name[Activity]

> Over the next 5 minutes, please identify what you have learned from the charts in each tab.

  - Write down your answers in the last tab (it is editable).  
  
  - Discuss your answers with your neighboring classmates.  
  
  - Be prepared to share these answers with class.

]

.panel[.panel-name[Book Stores]

<center>
<iframe src="https://fred.stlouisfed.org/graph/graph-landing.php?g=ZopX&width=800&height=420" scrolling="no" frameborder="0" style="overflow:hidden; width:800px; height:500px;" allowTransparency="true" loading="lazy"></iframe>
</center>

]


.panel[.panel-name[GDP 1]

<center>
<iframe src="https://fred.stlouisfed.org/graph/graph-landing.php?g=ZorB&width=800&height=420" scrolling="no" frameborder="0" style="overflow:hidden; width:800px; height:500px;" allowTransparency="true" loading="lazy"></iframe>
</center>

]


.panel[.panel-name[GDP 2]

<center>
<iframe src="https://fred.stlouisfed.org/graph/graph-landing.php?g=ZorL&width=800&height=420" scrolling="no" frameborder="0" style="overflow:hidden; width:800px; height:500px;" allowTransparency="true" loading="lazy"></iframe>
</center>
]

.panel[.panel-name[Key Points]

.can-edit.key-activity0b_viz[

**Main Insight(s):** .font70[(Insert below)]

  - **Book Stores:** Trend: ... | Seasonality: ... | Cycle: ...  
  
  - **GDP 1:** Trend: ... | Seasonality: ... | Cycle: ... 
  
  - **GDP 2:** Trend: ... | Seasonality: ... | Cycle: ...
]
]


]


---

# Need Assistance with Trends

```{r trends, echo=FALSE}
retailSales = read.csv('https://fred.stlouisfed.org/graph/fredgraph.csv?bgcolor=%23e1e9f0&chart_type=line&drp=0&fo=open%20sans&graph_bgcolor=%23ffffff&height=450&mode=fred&recession_bars=on&txtcolor=%23444444&ts=12&tts=12&width=1318&nt=0&thu=0&trc=0&show_legend=yes&show_axis_titles=yes&show_tooltip=yes&id=RSCCASN&scale=left&cosd=1992-01-01&coed=2023-07-01&line_color=%234572a7&link_values=false&line_style=solid&mark_type=none&mw=3&lw=2&ost=-99999&oet=99999&mma=0&fml=a&fq=Monthly&fam=avg&fgst=lin&fgsnd=2020-02-01&line_index=1&transformation=lin&vintage_date=2023-09-06&revision_date=2023-09-06&nd=1992-01-01') 

retailSales$DATE = lubridate::ymd(retailSales$DATE)

retailSales |> 
  ggplot2::ggplot(ggplot2::aes(x = DATE, y = RSCCASN)) +
  ggplot2::geom_line() + 
  ggplot2::scale_x_date(breaks = scales::pretty_breaks(n=22)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n=8), labels = scales::comma) +
  ggplot2::labs(x = "Date", y = "Retail Sales", 
       title = "Monthly Retail Sales (RSCCASN) in the U.S.") + 
  ggplot2::theme_bw() +
  ggplot2::geom_smooth(method = "lm") +
  ggplot2::geom_vline(ggplot2::aes(xintercept = as.numeric(as.Date("2001-03-01")), color = 'Recession 1')) +
  ggplot2::geom_vline(ggplot2::aes(xintercept = as.numeric(as.Date("2001-11-01")), color = 'Recession 1')) +
  ggplot2::geom_vline(ggplot2::aes(xintercept = as.numeric(as.Date("2007-12-01")), color = 'Recession 2')) +
  ggplot2::geom_vline(ggplot2::aes(xintercept = as.numeric(as.Date("2009-06-01")), color = 'Recession 2')) +
  ggplot2::geom_vline(ggplot2::aes(xintercept = as.numeric(as.Date("2020-03-01")), color = 'Recession 3')) +
  ggplot2::geom_vline(ggplot2::aes(xintercept = as.numeric(as.Date("2022-01-31")), color = 'Recession 3')) +
  ggplot2::scale_color_manual(name = 'Recessions', 
                     values = c(`Recession 1` = 'darkorange',
                                `Recession 2` = 'deepskyblue',
                                `Recession 3` = 'darkolivegreen')) +
  ggplot2::theme(panel.grid = ggplot2::element_blank(),
                  legend.position = 'bottom',
                  legend.margin=ggplot2::margin(0,0,0,0),
                  legend.box.margin=ggplot2::margin(-10,-10,-10,-10))
```

---

# Need Assistance with Seasonality

In [Section 2.2.1 of our reference book](https://wessexlearning.com/products/principles-of-business-forecasting-2nd-ed-part-i), the authors presented two approaches for considering seasonality. We can replicate them easily in `r fontawesome::fa(name = "r-project", fill = miamired)` and `r fontawesome::fa(name = "python", fill = miamired)`. Refer to the discussion in the next section for more detail.


---
class: inverse, center, middle

# The Grammar of Graphics and the `ggplot2` package


---

# A Visual Introduction to Graph Layers


```{r gg_layers1, echo=FALSE, out.width='100%', fig.alt="The ggplot2 and plotnine packages are based on the Grammar of Graphics (GG), which is a framework for data visualization that dissects each component of a graph into individual components, creating distinct layers. Using the GG system, we can build graphs step-by-step for flexible, customizable results.", fig.align='center', fig.cap='Schematic of some distinct layers in the Grammar of Graphics.'}
knitr::include_graphics("https://r.qcbs.ca/workshop03/book-en/images/Layers_ggplot.png")
```

.footnote[
<html>
<hr>
</html>

Figure from the QCBS R Workshop Series. It is from [Chapter 05 of their third workshop](https://r.qcbs.ca/workshop03/book-en/grammar-of-graphics-gg-basics.html).
]


---

# The Grammar of Graphics


```{r gg_layers2, echo=FALSE, out.width='57%', fig.alt="An overview of the layers highlighted in the Grammar of Graphics.", fig.align='center', fig.cap='An overview of the layers introduced in the Grammar of Graphics.'}
knitr::include_graphics("https://r.qcbs.ca/workshop03/book-en/images/gglayers.png")
```

.footnote[
<html>
<hr>
</html>

Figure from the QCBS R Workshop Series. It is from [Chapter 05 of their third workshop](https://r.qcbs.ca/workshop03/book-en/grammar-of-graphics-gg-basics.html).
]


---


# Grammar of Graphics Layers: Data

- Data needs to be in a **tidy** format (see next two slides).  

- The [dplyr](https://dplyr.tidyverse.org/reference/dplyr-package.html) and [tidyr](https://tidyr.tidyverse.org/) `r fontawesome::fa('box', fill ='gold')` can help with `tidying` your data. 


---

background-image: url(https://github.com/allisonhorst/stats-illustrations/raw/main/rstats-artwork/tidydata_1.jpg)
background-size: 95% 95%

.footnote[
**Source:** Illustration is from the Openscapes blog [Tidy Data for reproducibility, efficiency, and collaboration](https://www.openscapes.org/blog/2020/10/12/tidy-data/) by Julia Lowndes and Allison Horst
]

???

* In database, this is schema.
* Tidy data principles are a rephrase of third norm in a database schema design.
<https://en.wikipedia.org/wiki/Third_normal_form>, to data scientists.
* tidy data is for human consumption.
* Tabular data is column-oriented format

---

background-image: url(https://github.com/allisonhorst/stats-illustrations/raw/main/rstats-artwork/tidydata_2.jpg)
background-size: contain


.footnote[
**Source:** Illustration is from the Openscapes blog [Tidy Data for reproducibility, efficiency, and collaboration](https://www.openscapes.org/blog/2020/10/12/tidy-data/) by Julia Lowndes and Allison Horst
]


---

# Grammar of Graphics Layers: Aesthetics

**Aesthetics (`ggplot2::aes()`)** are used to make data visible. For example:  

  - `x`, `y`: variable to be plotted along the x and y axes.  
  - `color`: color of geoms (i.e., points, lines, etc) according to the data.
  - `fill`: the inside color of the geom (useful for bar charts).  
  - `group`: what group a geom belongs to (useful in multiple ts).  
  - `shape`: the shape of the plotted point (circle, triangle, filled circle, etc).  
  - `linetype`: the type of line used (solid, dashed, etc).  
  - `size`: size scaling for an extra dimension.  
  - `alpha`: the transparency of the geom
  
  
---

# Identify the Aesthetics Used in the Charts

```{r RSCCASN_data, include=FALSE}
if(require(tidyquant)==F) install.packages('tidyquant')

retail_sales = tidyquant::tq_get(
  x = 'RSCCASN', get = 'economic.data',
  from = '1992-01-01', to = Sys.Date()
  ) |> 
  dplyr::mutate(
    month = lubridate::month(date, label = T),
    year = lubridate::year(date)
  )

```


`r countdown(minutes = 6, seconds = 0, top = 0, font_size = "2em")`

.panelset[

.panel[.panel-name[Activity]

> Over the next 6 minutes, please identify the aesthetics used in each chart.

  - Write down your answers in the right-side of each tab (it is editable).  
  
  - You can discuss your answers with your neighboring classmates.  
  
  - Be prepared to share these answers with class.

]


.panel[.panel-name[Line Chart 1]

.pull-left-2[
```{r retailsales_linechart1, echo = F, out.width='100%'}
retail_sales |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = price)) +
  ggplot2::geom_line() + 
  ggplot2::scale_x_date( breaks = scales::pretty_breaks(n=22) ) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=8), 
    labels = scales::comma, limits = c(0, 45000)
  ) +
  ggplot2::labs(
    x = "Date", 
    y = "Retail Sales", 
    title = "Monthly Retail Sales (RSCCASN) in the U.S.") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank() )
```
]

.pull-right-2[

.can-edit.key-activity1a_viz[

**Main Aesthetics:** .font70[(Insert below)]

  - `x`: ....  and its class is: .... 
  
  - `y`: .... and its class is: ....
  
  - `group`: ..... 
  
  - `color`: .....
]
]
]


.panel[.panel-name[Line Chart 2]

.pull-left-2[
```{r retailsales_linechart2, echo = F, out.width='100%'}
retail_sales |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = price)) +
  ggplot2::geom_line() + 
  ggplot2::geom_point() + 
  ggplot2::scale_x_date( breaks = scales::pretty_breaks(n=8) ) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=8), 
    labels = scales::comma, limits = c(0, 45000)
  ) +
  ggplot2::labs(
    x = "Date", 
    y = "Retail Sales", 
    title = "Monthly Retail Sales (RSCCASN) in the U.S.") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank() ) +
  tidyquant::coord_x_date(xlim = c("2021-01-01", "2023-08-31"))
```
]

.pull-right-2[

.can-edit.key-activity1b_viz[

**Main Aesthetics:** .font70[(Insert below)]

  - `x`: ....  and its class is: .... 
  
  - `y`: .... and its class is: ....
  
  - `group`: ..... 
  
  - `color`: .....
]
]
]


.panel[.panel-name[Seasonal Chart 1]

.pull-left-2[
```{r retailsales_linechart3, echo = F, out.width='100%'}
retail_sales |> 
  dplyr::filter(date >= '2015-01-01' & date <= '2019-12-31') |> 
  dplyr::mutate(year = as.factor(year)) |> 
  ggplot2::ggplot(ggplot2::aes(x = month, y = price, color = year, group = year)) +
  ggplot2::geom_line() + 
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=8), 
    labels = scales::comma, limits = c(15000, 45000)
  ) +
  ggplot2::labs(
    x = "Month", 
    y = "Retail Sales", 
    title = "Monthly Retail Sales (RSCCASN) in the U.S.") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank(),
                  legend.position = 'bottom',
                  legend.margin=ggplot2::margin(0,0,0,0),
                  legend.box.margin=ggplot2::margin(-10,-10,-10,-10))
```
]

.pull-right-2[

.can-edit.key-activity1c_viz[

**Main Aesthetics:** .font70[(Insert below)]

  - `x`: ....  and its class is: .... 
  
  - `y`: .... and its class is: ....
  
  - `group`: ..... 
  
  - `color`: .....
]
]
]


.panel[.panel-name[Seasonal Chart 2]

.pull-left-2[
```{r retailsales_linechart4, echo = F, out.width='100%'}
retail_sales |> 
  dplyr::filter(date >= '2015-01-01' & date <= '2019-12-31') |> 
  dplyr::mutate(year = as.factor(year)) |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = price, color = year, group = year)) +
  ggplot2::geom_line() + 
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=8), 
    labels = scales::comma, limits = c(15000, 45000)
  ) +
  ggplot2::labs(
    x = "Date", 
    y = "Retail Sales", 
    title = "Monthly Retail Sales (RSCCASN) in the U.S.") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank(),
                  legend.position = 'bottom',
                  legend.margin=ggplot2::margin(0,0,0,0),
                  legend.box.margin=ggplot2::margin(-10,-10,-10,-10))
```
]

.pull-right-2[

.can-edit.key-activity1d_viz[

**Main Aesthetics:** .font70[(Insert below)]

  - `x`: ....  and its class is: .... 
  
  - `y`: .... and its class is: ....
  
  - `group`: ..... 
  
  - `color`: .....
]
]
]

]

---

# Grammar of Graphics Layers: Aesthetics

- Assigned **globally** to the entire plot via `ggplot2::ggplot(ggplot2::aes())`, or to **specific geoms** (e.g., `ggplot2::geom_point(ggplot2::aes()).` 

.pull-left[
```{r global_aes, echo = F, out.width='100%', fig.cap='The color is passed globally through ggplot(aes(x=date, y=price, color=year)).'}
retail_sales |> 
  dplyr::filter(date >= '2015-01-01') |> 
  dplyr::mutate(year = as.factor(year)) |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = price, color = year)) +
  ggplot2::geom_line() + 
  ggplot2::geom_point() + 
  ggplot2::scale_x_date( breaks = scales::pretty_breaks(n=8) ) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=8), 
    labels = scales::comma, limits = c(0, 45000)
  ) +
  ggplot2::labs(
    x = "Date", 
    y = "Retail Sales", 
    title = "Monthly Retail Sales (RSCCASN) in the U.S.") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank(),
                  legend.position = 'bottom',
                  legend.margin=ggplot2::margin(0,0,0,0),
                  legend.box.margin=ggplot2::margin(-10,-10,-10,-10)) +
  tidyquant::coord_x_date(xlim = c("2021-01-01", "2023-08-31"))
```
]


.pull-right[
```{r local_aes, echo = F, out.width='100%', fig.cap='The color is passed as an argument within the layer as geom_point(aes(color = year)).'}
retail_sales |> 
  dplyr::filter(date >= '2015-01-01') |> 
  dplyr::mutate(year = as.factor(year)) |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = price)) +
  ggplot2::geom_line() + 
  ggplot2::geom_point(ggplot2::aes(color = year)) + 
  ggplot2::scale_x_date( breaks = scales::pretty_breaks(n=8) ) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=8), 
    labels = scales::comma, limits = c(0, 45000)
  ) +
  ggplot2::labs(
    x = "Date", 
    y = "Retail Sales", 
    title = "Monthly Retail Sales (RSCCASN) in the U.S.") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank(),
                  legend.position = 'bottom',
                  legend.margin=ggplot2::margin(0,0,0,0),
                  legend.box.margin=ggplot2::margin(-10,-10,-10,-10)) +
  tidyquant::coord_x_date(xlim = c("2021-01-01", "2023-08-31"))
```
]


---

# Grammar of Graphics Layers: Individual Geoms


**Geometric objects** i.e., geoms help determine the type of plot. In this class, we will typically use one or more of the following *geoms*:  

- `ggplot2::geom_point()`: scatterplot or points in a line graph. 

- `ggplot2::geom_line()`: lines connecting points by increasing value of x.  

- `ggplot2::geom_smooth()`: to fit a function line (e.g., linear regression line) based on data.


---

# Grammar of Graphics Layers: Facets

We can use `ggplot2::facet_wrap()` to create small multiples based on a single variable. Arguments for `ggplot2::facet_wrap()` include:   
- `facets` which takes the variable of interest in quotes (i.e., `facets = 'symbol'`);  
- `nrow` and/or `ncol` which take numeric inputs for the number of rows and columns; and  
- `scales`, where we typically use `free_y` to denote that different `ylim` for each panel.

```{r faang, echo=TRUE}
fang_df = tidyquant::tq_get(
  x = c('META', 'AMZN', 'NFLX', 'GOOG'),
  from = '2010-01-01', to = Sys.Date()
)

colnames(fang_df)
```


---
count: false

# Grammar of Graphics Layers: Facets

We can use `ggplot2::facet_wrap()` to create small multiples based on a single variable. Arguments for `ggplot2::facet_wrap()` include:   
- `facets` which takes the variable of interest in quotes (i.e., `facets = 'symbol'`);  
- `nrow` and/or `ncol` which take numeric inputs for the number of rows and columns; and  
- `scales`, where we typically use `free_y` to denote that different `ylim` for each panel.

.pull-left[
```{r faang_linechart, echo = F, out.width='90%', fig.alt='A line chart of the FANG Closing Price Data.'}
fang_df |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = adjusted, group = symbol, color = symbol)) +
  ggplot2::geom_line() + 
  ggplot2::geom_point() + 
  ggplot2::scale_x_date( breaks = scales::pretty_breaks(n=8) ) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=8), 
    labels = scales::dollar
  ) +
  ggplot2::labs(
    x = "Date", 
    y = "Adjusted Closing Price", 
    title = "A line chart of the adjusted closing price for FANG companies") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank(),
                  legend.position = 'bottom',
                  legend.margin=ggplot2::margin(0,0,0,0),
                  legend.box.margin=ggplot2::margin(-10,-10,-10,-10)) +
  tidyquant::coord_x_date(xlim = c("2021-01-01", Sys.Date()))
```
]


.pull-right[
```{r faang_multiples, echo = F, out.width='90%', fig.alt='A panel chart of the FANG Closing Price Data.'}
fang_df |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = adjusted, group = symbol, color = symbol)) +
  ggplot2::geom_line() + 
  ggplot2::geom_point() + 
  ggplot2::scale_x_date( breaks = scales::pretty_breaks(n=4) ) +
  ggplot2::facet_wrap(facets = 'symbol', scales = 'free_y', nrow = 2) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=5), 
    labels = scales::dollar
  ) +
  ggplot2::labs(
    x = "Date", 
    y = "Adjusted Closing Price", 
    title = "A panel chart of the adjusted closing price for FANG companies") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank(),
                  legend.position = 'bottom',
                  legend.margin=ggplot2::margin(0,0,0,0),
                  legend.box.margin=ggplot2::margin(-10,-10,-10,-10)) +
  tidyquant::coord_x_date(xlim = c("2021-01-01", Sys.Date()))
```
]


---

# Grammar of Graphics Layers: Coordinates

In class, we will use the following two functions to create **snapshots** of the data:  

- `ggplot2::coord_cartesian()` to set limits. We will specicially use its xlim argument to create a snapshot when the $x$ axis contains a continous variable (e.g., year). See [ggplot2 documentation](https://ggplot2.tidyverse.org/reference/coord_cartesian.html) for more detail.      
- `tidyquant::coord_x_date()` to set limits. We will specicially use its xlim argument to create a snapshot when the $x$ axis contains a date variable (with a `class` of date).  See [tidyquant documentation](https://business-science.github.io/tidyquant/reference/coord_x_date.html) for more detail. 


---

# Grammar of Graphics: Themes

Themes control the overall visual defaults. There are some themes built within the `ggplot2` `r fontawesome::fa('box', 'gold')` (see the [complete themes guide](https://ggplot2.tidyverse.org/reference/ggtheme.html)). For additional themes, please feel free to play with the [ggthemes](https://github.com/jrnold/ggthemes) `r fontawesome::fa('box', 'gold')`.


.pull-left[
```{r fang_theme1, echo=FALSE, out.width='100%', fig.cap='Default ggplot2 theme'}
fang_df |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = adjusted, group = symbol, color = symbol)) +
  ggplot2::geom_line() + 
  ggplot2::geom_point() + 
  ggplot2::scale_x_date( breaks = scales::pretty_breaks(n=8) ) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=8), 
    labels = scales::dollar
  ) +
  ggplot2::labs(
    x = "Date", 
    y = "Adjusted Closing Price", 
    title = "A line chart of the adjusted closing price for FANG companies") + 
  # ggplot2::theme_bw() +
  # ggplot2::theme( panel.grid = ggplot2::element_blank(),
  #                 legend.position = 'bottom',
  #                 legend.margin=ggplot2::margin(0,0,0,0),
  #                 legend.box.margin=ggplot2::margin(-10,-10,-10,-10)) +
  tidyquant::coord_x_date(xlim = c("2021-01-01", Sys.Date()))
```
]

.pull-right[
```{r fang_theme2, echo=FALSE, out.width='100%', fig.cap='A modified theme (no gridlines, no gray background and caption is place below).'}
fang_df |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = adjusted, group = symbol, color = symbol)) +
  ggplot2::geom_line() + 
  ggplot2::geom_point() + 
  ggplot2::scale_x_date( breaks = scales::pretty_breaks(n=8) ) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(n=8), 
    labels = scales::dollar
  ) +
  ggplot2::labs(
    x = "Date", 
    y = "Adjusted Closing Price", 
    title = "A line chart of the adjusted closing price for FANG companies") + 
  ggplot2::theme_bw() +
  ggplot2::theme( panel.grid = ggplot2::element_blank(),
                  legend.position = 'bottom',
                  legend.margin=ggplot2::margin(0,0,0,0),
                  legend.box.margin=ggplot2::margin(-10,-10,-10,-10)) +
  tidyquant::coord_x_date(xlim = c("2021-01-01", Sys.Date()))
```
]



---
class: inverse, center, middle

# Putting it all together


---

# A Singular TS: AAPL's Adj. Close

```{r demo_dataset}
if(require(tidyquant)==F) install.packages("tidyquant") # install if needed
if(require(tidyverse)==F) install.packages('tidyverse') # install if needed

aapl = # get AAPL stock data from 1st trading day after Jan 1, 2020 to now
  tidyquant::tq_get(x = 'AAPL', from = '2020-01-01', to = Sys.Date() ) |> 
  # select (i.e., keep) only the variables below
  dplyr::select( c(date, symbol, adjusted) ) |> 
  # create the following variables: year and month
  dplyr::mutate(
    # date has to be of class Date if not use lubridate::ymd (mdy, dmy, etc)
    # to convert the string variable to date
    year = lubridate::year(date), 
    month = lubridate::month(date, label = T)
  )
tail(aapl, n = 1) # print the last obs  to see what we have 
```


---

# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl1, eval=FALSE}
# layers are + in ggplot2 #<<
ggplot2::ggplot(aapl) #<<
```
]
]
.right-plot[
```{r aapl1_out, ref.label='aapl1', echo=FALSE, fig.dim=c(4.8, 4), out.width="100%"}

```
]


---
count:false
# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl2, eval=FALSE}
# layers are + in ggplot2 
ggplot2::ggplot(
  aapl, 
  ggplot2::aes(x = date, y = adjusted) #<<
)
```
]
]
.right-plot[
```{r aapl2_out, ref.label='aapl2', echo=FALSE, fig.dim=c(4.8, 4), out.width="100%"}

```
]


---
count:false
# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl3, eval=FALSE}
# layers are + in ggplot2 
ggplot2::ggplot(
  aapl, 
  ggplot2::aes(x = date, y = adjusted)
) +
  ggplot2::geom_point() #<<
```
]
]
.right-plot[
```{r aapl3_out, ref.label='aapl3', echo=FALSE, fig.dim=c(4.8, 4), out.width="100%"}

```
]


---
count:false
# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl4, eval=FALSE}
# layers are + in ggplot2 
ggplot2::ggplot(
  aapl, 
  ggplot2::aes(x = date, y = adjusted)
) +
  ggplot2::geom_point(
    ggplot2::aes(color = month) #<<
  ) 
```
]
]
.right-plot[
```{r aapl4_out, ref.label='aapl4', echo=FALSE, fig.dim=c(4.8, 4), out.width="100%"}

```
]


---
count:false
# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl5, eval=FALSE}
# layers are + in ggplot2 
ggplot2::ggplot(
  aapl, 
  ggplot2::aes(x = date, y = adjusted)
) +
  ggplot2::geom_point(
    ggplot2::aes(color = month)
  ) +
  ggplot2::geom_line() #<<
```
]
]
.right-plot[
```{r aapl5_out, ref.label='aapl5', echo=FALSE, fig.dim=c(4.8, 4), out.width="100%"}

```
]


---
count:false
# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl6, eval=FALSE}
# layers are + in ggplot2 
ggplot2::ggplot(
  aapl, 
  ggplot2::aes(x = date, y = adjusted)
) +
  ggplot2::geom_point(
    ggplot2::aes(color = month) 
  ) +
  ggplot2::geom_line() +
  ggplot2::geom_smooth( #<<
    method = lm, formula = 'y ~ x' #<<
    ) #<<
```
]
]
.right-plot[
```{r aapl6_out, ref.label='aapl6', echo=FALSE, fig.dim=c(4.8, 4), out.width="100%"}

```
]


---
count:false
# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl7, eval=FALSE}
# layers are + in ggplot2 
ggplot2::ggplot(
  aapl, 
  ggplot2::aes(x = date, y = adjusted)
) +
  ggplot2::geom_point(
    ggplot2::aes(color = month) 
  ) +
  ggplot2::geom_line() +
  ggplot2::geom_smooth( 
    method = lm, formula = 'y ~ x'
    )  +
  ggplot2::scale_x_date( #<<
    breaks = scales::pretty_breaks(n=8) #<<
    ) + #<<
  ggplot2::scale_y_continuous( #<<
    breaks = scales::pretty_breaks(n=6), #<<
    labels = scales::dollar) #<<
```
]
]
.right-plot[
```{r aapl7_out, ref.label='aapl7', echo=FALSE, fig.dim=c(4.8, 4), out.width="100%"}

```
]



---
count:false
# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl8, eval=FALSE}
# layers are + in ggplot2 
ggplot2::ggplot(
  aapl, 
  ggplot2::aes(x = date, y = adjusted)
) +
  ggplot2::geom_point(
    ggplot2::aes(color = month) 
  ) +
  ggplot2::geom_line() +
  ggplot2::geom_smooth( 
    method = lm, formula = 'y ~ x' 
    )  +
  ggplot2::scale_x_date( 
    breaks = scales::pretty_breaks(n=8) 
    ) + 
  ggplot2::scale_y_continuous( 
    breaks = scales::pretty_breaks(n=6), 
    labels = scales::dollar) +
  tidyquant::coord_x_date( #<<
    xlim = c('2023-06-01', '2023-09-30')  #<<
    ) #<<
```
]
]
.right-plot[
```{r aapl8_out, ref.label='aapl8', echo=FALSE, fig.dim=c(4.8, 4), out.width="100%"}

```
]


---
count:false
# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl9, eval=FALSE}
# layers are + in ggplot2 
ggplot2::ggplot(
  aapl, 
  ggplot2::aes(x = date, y = adjusted)
) +
  ggplot2::geom_point(
    ggplot2::aes(color = month) 
  ) +
  ggplot2::geom_line() +
  ggplot2::geom_smooth( 
    method = lm, formula = 'y ~ x' 
    )  +
  ggplot2::scale_x_date( 
    breaks = scales::pretty_breaks(n=8) 
    ) + 
  ggplot2::scale_y_continuous( 
    breaks = scales::pretty_breaks(n=6), 
    labels = scales::dollar) +
  tidyquant::coord_x_date( 
    xlim = c('2023-06-01', '2023-09-30')  
    ) +
  ggplot2::theme_bw(base_size = 14) + #<<
  ggplot2::theme(  #<<
    legend.position = 'bottom' #<<
    ) #<<
```
]
]

.right-plot[
```{r aapl9_out, ref.label='aapl9', echo=FALSE, fig.dim=c(4.8, 4), out.width="100%"}

```
]


---
count:false
# A Singular TS: The GG Layers

.left-code[
.small[
```{r aapl10, eval=FALSE}
# layers are + in ggplot2 
ggplot2::ggplot(
  aapl, 
  ggplot2::aes(x = date, y = adjusted)
) +
  ggplot2::geom_point(
    ggplot2::aes(color = month) 
  ) +
  ggplot2::geom_line() +
  ggplot2::geom_smooth( 
    method = lm, formula = 'y ~ x' 
    )  +
  ggplot2::scale_x_date( 
    breaks = scales::pretty_breaks(n=8) 
    ) + 
  ggplot2::scale_y_continuous( 
    breaks = scales::pretty_breaks(n=6), 
    labels = scales::dollar) +
  tidyquant::coord_x_date( 
    xlim = c('2023-06-01', '2023-09-30') 
    ) +
  ggplot2::theme_bw(base_size = 14) + 
  ggplot2::theme(  
    legend.position = 'bottom' 
    ) -> aapl_plot #<<

plotly::ggplotly(p = aapl_plot) #<<
```
]
]

.right-plot[
```{r aapl10_out, ref.label='aapl10', echo=FALSE, fig.dim=c(4.8, 4), out.height='330px', out.width='350px'}

```
]


---

# A Singular TS: `r fontawesome::fa(name = "python", fill = miamired)` Implementation

.left-code[
.small[
```{python aapl10p, eval = F}
import yfinance as yf
import datetime as dt
from plotnine import ggplot, aes, theme, theme_bw, geom_line, geom_point, geom_smooth

# extracting the data using yfinance library (install via pip in console)
aapl = yf.download(tickers=['AAPL'], start=dt.datetime(2021, 1, 1), end=dt.datetime(2023, 9, 6))

# creating features
aapl.reset_index(inplace = True) # convert the index into a Date column
aapl['month'] = aapl['Date'].dt.month
aapl['year'] = aapl['Date'].dt.year

# plotting using plotnine
(
  ggplot(aapl, aes(x = 'Date', y = 'Adj Close')) +
  geom_point( aes(color = 'month') ) +
  geom_line() +
  geom_smooth() +
  theme_bw(base_size = 8) +
  theme(legend_position = 'bottom')
  )
```
]
]

.right-plot[
```{python aapl10p_out, ref.label='aapl10p', echo=FALSE, fig.dim=c(4.8, 4), out.height='330px', out.width='350px', warning= FALSE, message = FALSE}

```
]


---

# Demo: `ts()` in `r fontawesome::fa(name = "r-project", fill = miamired)` & `yfinance` in `r fontawesome::fa(name = "python", fill = miamired)`?

```{r demo_ts, include=FALSE, eval = F}
# option 1
forecast::autoplot(JohnsonJohnson)

# option 2
jj_df = data.frame(
  date = zoo::as.Date(x = time(JohnsonJohnson)),
  earnings = JohnsonJohnson
)

ggplot2::ggplot(
  jj_df, ggplot2::aes(x = date, y = earnings) ) +
  ggplot2::geom_line()

```

```{python demo_yfin, include = F}
import yfinance as yf
import datetime as dt

# extracting the data using yfinance library (install via pip in console)
aapl = yf.download(tickers=['AAPL'], start=dt.datetime(2021, 1, 1), end=dt.datetime(2023, 9, 6))

# creating features
aapl.reset_index(inplace = True) # convert the index into a Date column
```


---
class: inverse, center, middle

# A Summarizing Time-Series Data


---

# Measures of Average

**Mean:** Given a set of $n$ values $Y_1, \, Y_2, \, \dots, \, Y_n$, the arithmetic mean can be computed as:    
$$\bar{Y} = \frac{Y_1 + Y_2 + \dots + Y_n}{n} = \frac{1}{n}\sum_{i=1}^{i=n}Y_i.$$

<br>


**Order Statistics:**
Given a set of $n$ values $Y_1, \, Y_2, \, \dots, \, Y_n$, we place them in an ascending order to define the order statistics, written as $Y_{(1)}, \, Y_{(2)}, \, \dots, \, Y_{(n)}.$


**Median:**
- If $n$ is odd, $n = 2m + 1$ and the median is $Y_{(m+1)}$.   
- If $n$ is even, $n = 2m$ and the median is the average of the two middle numbers, i.e.,  $\frac{1}{2}[Y_{(m)} + Y_{(m+1)}]$.
  

---

# Measures of Variation

The **range** denotes the difference between the largest and smallest value in a sample:   
$$Range = Y_{(n)} - Y_{(1)}.$$


The **deviation** is defined as the difference between a given observation $Y_i$ and the mean $\bar{Y}$.

The **mean absolute deviation (MAD)** is the average deviations about the mean, irrespective of their sign:
$$
\text{MAD} = \frac{\sum_{i=1}^{i=n}|d_i|}{n}.
$$

The **variance** is the average of the squared deviations around the mean:  
$$
S^2 = \frac{\sum_{i=1}^{i=n}d_i^2}{n-1}.
$$


---

# The GameStop Short Squeeze

.center[
```{r gme_get, echo=FALSE, out.height='300px', out.width='600px', cache=FALSE}
gme_get = tidyquant::tq_get(x = 'GME', from = '2019-06-01', to = '2020-03-16') |> 
  dplyr::select(date, adjusted)

gme_get |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = adjusted)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::scale_x_date(breaks = scales::pretty_breaks(n = 4)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  ggplot2::theme_bw() -> static_plot

plotly::ggplotly(
  static_plot,
  tooltip = c("x", "y")
)
  
```
]

.footnote[
<html>
<hr>
</html>

**Note:** Click [Gamestop Short Squeeze](https://en.wikipedia.org/wiki/GameStop_short_squeeze) for more details.
]


---

## Summarizing the GME Short Squeeze: Avg/Var Measures

.pull-left-2[
.font80[
```{r gme_story1, eval=FALSE}
gme_get = 
  tidyquant::tq_get(x = 'GME', from = '2019-06-01', to = '2020-03-16') |> 
  dplyr::select(date, adjusted) |> 
  dplyr::mutate(
    year = lubridate::year(date), 
    month = lubridate::month(date, label = T)
  )

gme_get

```
]
]

.pull-right-2[
```{r gme_story1_out, ref.label='gme_story1', echo=FALSE, fig.dim=c(4, 4), out.height='330px', out.width='275px'}

```
]


---
count: false

## Summarizing the GME Short Squeeze: Avg/Var Measures

.pull-left-2[
.font80[
```{r gme_story2, eval=FALSE}
gme_get = 
  tidyquant::tq_get(x = 'GME', from = '2019-06-01', to = '2020-03-16') |> 
  dplyr::select(date, symbol, adjusted) |> 
  dplyr::mutate(
    year = lubridate::year(date), 
    month = lubridate::month(date, label = T)
  )

gme_summary = #<<
  gme_get |> #<<
  dplyr::group_by(symbol) #<<

gme_summary

```
]
]

.pull-right-2[
```{r gme_story2_out, ref.label='gme_story2', echo=FALSE, fig.dim=c(4, 4), out.height='330px', out.width='275px'}

```
]


---
count: false

## Summarizing the GME Short Squeeze: Avg/Var Measures

.pull-left-2[
.font80[
```{r gme_story3, eval=FALSE}
gme_get = 
  tidyquant::tq_get(x = 'GME', from = '2019-06-01', to = '2020-03-16') |> 
  dplyr::select(date, symbol, adjusted) |> 
  dplyr::mutate(
    year = lubridate::year(date), 
    month = lubridate::month(date, label = T)
  )

gme_summary = 
  gme_get |> 
  dplyr::group_by(symbol) |> 
  dplyr::summarise( #<<
    ajusted_avg = mean(adjusted), #<<
    adjusted_med = median(adjusted), #<<
    adjusted_var = var(adjusted), #<<
    adjusted_sd = sd(adjusted) #<<
  ) #<<

gme_summary |> t() # transposing for printout

```
]
]

.pull-right-2[
```{r gme_story3_out, ref.label='gme_story3', echo=FALSE, fig.dim=c(4, 4), out.height='330px', out.width='275px'}

```
]


---
count: false

## Summarizing the GME Short Squeeze: Avg/Var Measures

.pull-left-2[
.font80[
```{r gme_story4, eval = FALSE}
gme_get = 
  tidyquant::tq_get(x = 'GME', from = '2019-06-01', to = '2020-03-16') |> 
  dplyr::select(date, symbol, adjusted) |> 
  dplyr::mutate(
    year = lubridate::year(date), 
    month = lubridate::month(date, label = T)
  )

gme_summary = 
  gme_get |> 
  dplyr::group_by(symbol, year) |> #<<
  dplyr::summarise( 
    ajusted_avg = mean(adjusted), 
    adjusted_med = median(adjusted), 
    adjusted_var = var(adjusted), 
    adjusted_sd = sd(adjusted) 
  )

gme_summary
```

]
]

.pull-right-2[
```{r gme_story4_out, ref.label='gme_story4', echo=FALSE, fig.dim=c(4, 4), out.height='330px', out.width='275px'}

```
]


---
count: false

## Summarizing the GME Short Squeeze: Avg/Var Measures

.pull-left-2[
.font80[
```{r gme_story5, eval=FALSE}
gme_get = 
  tidyquant::tq_get(x = 'GME', from = '2019-06-01', to = '2020-03-16') |> 
  dplyr::select(date, symbol, adjusted) |> 
  dplyr::mutate(
    year = lubridate::year(date), 
    month = lubridate::month(date, label = T)
  )

gme_summary = 
  gme_get |> 
  dplyr::group_by(symbol, year, month) |> #<<
  dplyr::summarise( 
    ajusted_avg = mean(adjusted), 
    adjusted_med = median(adjusted), 
    adjusted_var = var(adjusted), 
    adjusted_sd = sd(adjusted) 
  )

print(gme_summary, n=15)
```

]
]

.pull-right-2[
```{r gme_story5_out, ref.label='gme_story5', echo=FALSE, fig.dim=c(4, 4), out.height='330px', out.width='275px'}

```

]


---

# A Demo in `r fontawesome::fa(name = "python", fill = miamired)`

```{python gme_demo, include = FALSE}
import pandas as pd
import yfinance as yf

# Fetch GME data from Yahoo Finance
gme_data = yf.download('GME', start = '2019-06-01', end = '2020-03-15')

# Select relevant columns
gme_get = gme_data.reset_index()[['Date', 'Adj Close']]
gme_get.columns = ['date', 'adjusted']

# Add year and month columns
gme_get['year'] = gme_get['date'].dt.year
gme_get['month'] = gme_get['date'].dt.month_name()

# Calculate the range and mean absolute deviation along with other statistics
gme_summary = gme_get.groupby('year').agg({
    'adjusted': [
        'mean', 
        'median', 
        'var', 
        'std',
        lambda x: x.max() - x.min(),  # range
        lambda x: (x - x.mean()).abs().mean() # mad
    ]
}).reset_index()

# Rename summary columns
gme_summary.columns = [
    'year', 
    'adjusted_avg', 
    'adjusted_med', 
    'adjusted_var', 
    'adjusted_sd',
    'adjusted_range',
    'adjusted_mad'
]

gme_summary

```

---
class: inverse, center, middle

# Correlation

---

# The Pearson Correlation Coefficient

- **Correlation:** measures the strength of the **linear relationship** between two quantitative variables.

- It can be computed using the `cor()` from base R. Mathematically speaking, the pearson correlation coefficient, $r$, can be computed as
$$r = \frac{\sum_{i=1}^{n} (X_i - \bar{X})(Y_i - \bar{Y})}{\sqrt{\sum_{i=1}^{n}(X_i - \bar{X})^2 \sum_{i=1}^{n}(Y_i - \bar{Y})^2}}$$


- Do **not** use the Pearson Correlation coefficient if both variables are not quantitative. Instead, refer to the `mixed.cor()` from the [psch package](https://personality-project.org/r/psych/help/mixed.cor.html) to compute the correlations for mixtures of continuous, polytomous, and/or dichotomous variables.

- You should supplement **any descriptive summaries with visualizations** to ensure that you are able to interpret the computations correctly.


---

## Supplement Summaries with Viz: Anscombe's Dataset

**In a seminal paper, Anscombe stated:** 

> **Few of us escape being indoctrinated with these notions:** 
>  - numerical **calculations are exact, but graphs are rough**; 
>  - for any particular kind of **statistical data there is just one set of calculations constituting a correct statistical analysis**;  
>  - performing **intricate calculations is virtuous**, whereas **actually looking at the data is cheating**.

He proceeded by stating that 
> a computer should **make both calculations and graphs**. Both sorts of output should be studied; each will contribute to understanding.

Now, let us consider his four datasets, each consisting of eleven (x,y) pairs.

.footnote[
<html>
<hr>
</html>
**Source:** Anscombe, Francis J. 1973. "Graphs in Statistical Analysis." *The American Statistician* 27 (1): 17–21. ([PDF Link](https://www.sjsu.edu/faculty/gerstman/StatPrimer/anscombe1973.pdf)). 

---
count: false

## Supplement Summaries with Viz: Anscombe's Dataset

.font80[
```{r anscombe2, echo=FALSE, out.height='500px'}
DT::datatable(anscombe, rownames = FALSE, options = list(pageLength = 11, dom = 'tip'))
```
]

---
count: false

## Supplement Summaries with Viz: Anscombe's Dataset

.font80[
```{r anscombe3, echo = FALSE, out.height='500px'}
df = 
  Tmisc::quartet |>  
  dplyr::group_by(set) |> 
  dplyr::summarise(
    x.mean = mean(x) |>  round(digits = 2), 
    x.sd = sd(x) |> round(digits = 2),
    y.mean = mean(y) |> round(digits = 2), 
    y.sd = sd(y) |> round(digits = 2),
    corr = cor(x, y) |> round(digits = 2)
    )

DT::datatable(
  df, rownames = FALSE, 
  options = list(pageLength = 5, dom = 'tip')
  )
```
]


---
count: false

## Supplement Summaries with Viz: Anscombe's Dataset

```{r anscombe4, echo=FALSE}
ggplot2::ggplot(Tmisc::quartet, ggplot2::aes(x, y)) + 
  ggplot2::geom_point() + 
  ggplot2::geom_smooth(method = lm, se = FALSE) + 
  ggplot2::facet_wrap(~set) + 
  ggplot2::theme_bw() +
  ggplot2::scale_x_continuous(
    breaks = scales::pretty_breaks(10), limits = c(0, 20)
  ) +
  ggplot2::scale_y_continuous(
    breaks = scales::pretty_breaks(10), limits = c(0,15)
  )
```

---
class: inverse, center, middle

# Recap

---

# Summary of Main Points

By now, you should be able to do the following:  

- Examine the goals of utilizing line charts in time-series analysis (i.e., detect trends, seasonality, and cycles).  

- Develop a deeper understanding of the grammar of graphics, which we used to create time series plots in `r fontawesome::fa(name = "r-project", fill = miamired)` and `r fontawesome::fa(name = "python", fill = miamired)`.  
- Use numerical summaries to describe a time series.  

- Explain what do we mean by correlation.  

---

# 📝 Review and Clarification 📝

1. **Class Notes**: Take some time to revisit your class notes for key insights and concepts.
2. **Zoom Recording**: The recording of today's class will be made available on Canvas approximately 3-4 hours after the session ends.
3. **Questions**: Please don't hesitate to ask for clarification on any topics discussed in class. It's crucial not to let questions accumulate. 


---

# 📖 Required Readings 📖

.pull-left[
.center[[<img src="https://d33wubrfki0l68.cloudfront.net/b88ef926a004b0fce72b2526b0b5c4413666a4cb/24a30/cover.png" height="350px">](https://r4ds.had.co.nz)]
]

.pull-right[

* [Data Visualization](https://r4ds.had.co.nz/data-visualisation.html)  

* [Graphics for Communication](https://r4ds.had.co.nz/graphics-for-communication.html)  

* [Dates and Times](https://r4ds.had.co.nz/dates-and-times.html)  

]

---

# 🎯 Assignment 🎯

- Go over your notes and complete [Assignment 02](https://miamioh.instructure.com/courses/200821/quizzes/582798) on Canvas. 


```{python assignment_sol, include = F}
import pandas as pd
import pandas_datareader.data as pdr
import datetime as dt
from plotnine import ggplot, aes, theme, theme_bw, geom_line, geom_point, geom_smooth, labs

# reading the data
df_fred = pdr.DataReader('MEDDAYONMARUS', 'fred', start = dt.datetime(2016, 7,1)).reset_index()

# questions 1 and 2
# -----------------
df_fred['month'] = df_fred['DATE'].dt.month.astype('category')
df_fred['year'] = df_fred['DATE'].dt.year.astype('category')

(
  ggplot(df_fred, aes(x='DATE', y='MEDDAYONMARUS')) +
  geom_point(aes(color = 'month'), size = 3) +
  geom_line(aes(group = 'year')) + # grouping only for the line so it does not affect the LM
  geom_smooth(method = 'lm') +
  labs(x='Date', y='MEDDAYONMARUS', title='Trend and Seasonality of MEDDAYONMARUS Over Time') +
  theme_bw()
)


# questions 3 and 4
# -----------------
# Group by month and calculate the mean for each
df_grouped = df_fred.groupby('month')['MEDDAYONMARUS'].mean().reset_index()

# Sort and find the month with the second highest mean value

# Option 1: print and pick the second row from top
df_grouped.sort_values(by='MEDDAYONMARUS', ascending=False)

# Option 2: pull the value for that specific month (cleaner solution)
df_grouped.sort_values(by='MEDDAYONMARUS', ascending=False).iloc[1]['month']
df_grouped.sort_values(by='MEDDAYONMARUS', ascending=False).iloc[1]['MEDDAYONMARUS']

```

```{r solution, include = F}
# Reading the data
df_fred = tidyquant::tq_get("MEDDAYONMARUS", get = 'economic.data')

# Questions 1 and 2
# -----------------
# Extract month and year and convert them to factors (categorical)
df_fred$month = lubridate::month(df_fred$date) |> as.factor()
df_fred$year = lubridate::year(df_fred$date) |> as.factor()

# Create the plot
ggplot2::ggplot(df_fred, ggplot2::aes(x = date, y = price)) +
  ggplot2::geom_point(ggplot2::aes(color = month), size = 3) +
  ggplot2::geom_line(ggplot2::aes(group = year)) + # grouping only for the line so it does not affect the LM
  ggplot2::geom_smooth(method = "lm") +
  ggplot2::labs(x = "Date", y = "MEDDAYONMARUS", title = "Trend and Seasonality of MEDDAYONMARUS Over Time") +
  ggplot2::theme_bw(base_size = 8)




# Questions 3 and 4
# -----------------
# Group by month and calculate the mean for each
df_grouped = dplyr::group_by(df_fred, month) |> 
  dplyr::summarise(mean_MEDDAYONMARUS = mean(price))

# Sort and find the month with the second highest mean value
# Option 1: View and pick the second row from top
df_sorted = dplyr::arrange(df_grouped, desc(mean_MEDDAYONMARUS))

# Option 2: pull the value for that specific month (cleaner solution)
second_highest_month = df_sorted[2, "month"]
second_highest_mean_value = df_sorted[2, "mean_MEDDAYONMARUS"]

# Print the results
print(paste("The month with the second highest MEDDAYONMARUS is:", second_highest_month))
print(paste("The mean MEDDAYONMARUS value for the second-highest month is:", second_highest_mean_value))

```

