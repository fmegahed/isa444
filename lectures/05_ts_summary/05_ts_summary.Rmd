---
title: "ISA 444: Business Forecasting"
subtitle: '05: Time Series Summaries'
author: '<br>Fadel M. Megahed, PhD <br><br> Endres Associate Professor <br> Farmer School of Business<br> Miami University<br><br> [`r icons::icon_style(icons::fontawesome("twitter"), fill = "white")` @FadelMegahed](https://twitter.com/FadelMegahed) <br> [`r icons::icon_style(icons::fontawesome("github"), fill = "white")` fmegahed](https://github.com/fmegahed/) <br> [`r icons::icon_style(icons::fontawesome("paper-plane", style = "solid"), fill = "white")` fmegahed@miamioh.edu](mailto:fmegahed@miamioh.edu)<br> [`r icons::icon_style(icons::fontawesome("question"), fill = "white")` Automated Scheduler for Office Hours](https://calendly.com/fmegahed)<br><br>'
date: "Fall 2023"
output:
  xaringan::moon_reader:
    self_contained: true
    css: [default, "../../style_files/fonts.css", "../../style_files/my-theme.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      highlightLanguage: ["r"]
      countIncrementalSlides: false
      ratio: "16:9"
header-includes:  
  - "../../style_files/header.html"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      progress = FALSE, 
                      verbose = FALSE,
                      dev = 'png',
                      dpi = 300,
                      fig.asp = 0.618,
                      fig.align = 'center',
                      out.width = '70%')

options(htmltools.dir.version = FALSE)


miamired = '#C3142D'

if(require(pacman)==FALSE) install.packages("pacman")
if(require(devtools)==FALSE) install.packages("devtools")
if(require(countdown)==FALSE) devtools::install_github("gadenbuie/countdown")
if(require(xaringanExtra)==FALSE) devtools::install_github("gadenbuie/xaringanExtra")
if(require(emo)==FALSE) devtools::install_github("hadley/emo")
if(require(icons)==FALSE) devtools::install_github("mitchelloharawild/icons")

pacman::p_load(gifski, av, gganimate, ggtext, glue, extrafont, # for animations
               emojifont, emo, RefManageR, xaringanExtra, countdown, downlit) # for slides
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
if(require(xaringanthemer) == FALSE) install.packages("xaringanthemer")
library(xaringanthemer)

style_mono_accent(base_color = "#84d6d3",
                  base_font_size = "20px")

xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)

xaringanExtra::use_xaringan_extra(c("tile_view", "animate_css", "tachyons", "panelset", "share_again", "search", "fit_screen", "editable", "clipboard"))

```


# Quick Refresher from Last Class

`r emo::ji("check")` - Examine the goals of utilizing line charts in time-series analysis (i.e., detect trends, seasonality, and cycles).   

`r emo::ji("check")` Develop a deeper understanding of the grammar of graphics, which we used to create time series plots in `r fontawesome::fa(name = "r-project", fill = miamired)` and `r fontawesome::fa(name = "python", fill = miamired)`.  

`r emo::ji("check")` Use numerical summaries to describe a time series.   

`r emo::ji("check")` Explain what do we mean by correlation.    



---

# Learning Objectives for Today's Class

- Apply transformations to a time series in both `r fontawesome::fa(name = "r-project", fill = miamired)` and `r fontawesome::fa(name = "python", fill = miamired)`.  


---
class: inverse, center, middle

# Transformations

---

# Guidelines for Transforming Time Series Data

```{r run_latex_file, echo=FALSE, cache=TRUE, results='hide'}
tinytex::xelatex('../../figures/transformations.tex')
Sys.sleep(1)
pdftools::pdf_convert('../../figures/transformations.pdf', dpi = 600,
                      filenames = '../../figures/transformations.png')
Sys.sleep(1)
```

```{r read_ts_taxonomy, echo=FALSE, out.width='100%', fig.alt="A classification of common transformation approaches for time series data", fig.align='center', fig.cap='A classification of common transformation approaches for time series data'}
knitr::include_graphics("../../figures/transformations.png")
```

.footnote[
<html>
<hr>
</html>

My (incomplete) attempt to provide you with a taxonomy for time series data transformations.
]


---

# Stablize the Mean: Differencing

The plot below shows the number of murdered women per 100,000 people in the U.S. From the plot, we can see that the ts is not stationary. 

```{r murdered_women, echo = F}
women_murdered = 
  readr::read_csv('../../data/murdered_women_per_100000_people.csv') |> 
  dplyr::filter(country == 'United States') |> 
  tidyr::pivot_longer(cols = 2:68, names_to = 'year', values_to = 'murders_per_100000') |> 
  dplyr::mutate(year = as.numeric(year)) |> 
  na.omit()

women_murdered |> 
  ggplot2::ggplot(ggplot2::aes(x = year, y = murders_per_100000)) +
  ggplot2::geom_point(size = 1.25) +
  ggplot2::geom_line() +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  ggplot2::theme_bw()

```

---
count:false

# Stablize the Mean: Differencing

The plot below shows the **first nonseasonal difference**. From the plot, we can see that differencing has reduced the nonstationary nature of the time-series. 

```{r murdered_women2, echo = F}
women_murdered |> 
  dplyr::mutate(diff_murders = murders_per_100000 - dplyr::lag(murders_per_100000)) |> 
  ggplot2::ggplot(ggplot2::aes(x = year, y = diff_murders)) +
  ggplot2::geom_point(size = 1.25) +
  ggplot2::geom_line() +
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  ggplot2::theme_bw()
```

---


# Computing the First Nonseasonal Difference

The change in the time series from one period to the next is known as the first nonseasonal difference. It can be computed as follows:  

$$DY_t = Y_t - Y_{t-1}$$

.pull-left-2[
.font80[
.center[`r fontawesome::fa(name = "r-project", fill = miamired)`]
```{r murdered_women3, eval=FALSE}
women_murdered_filtered = 
  women_murdered |> # dataset read in previous lines of code
  dplyr::filter(year > 2000)

print(women_murdered_filtered)
```
]
]

.pull-right-2[
.center[`r fontawesome::fa(name = "r-project", fill = miamired)` **Output**]
```{r murdered_women3_out, ref.label='murdered_women3', echo=FALSE, fig.dim=c(4, 4), out.height='330px', out.width='275px'}

```
]


---
count:false

# Computing the First Nonseasonal Difference

The change in the time series from one period to the next is known as the first nonseasonal difference. It can be computed as follows:  

$$DY_t = Y_t - Y_{t-1}$$

.pull-left-2[
.font80[
.center[`r fontawesome::fa(name = "r-project", fill = miamired)`]
```{r murdered_women4, eval=FALSE}
women_murdered_filtered = 
  women_murdered |> # dataset read in previous lines of code
  dplyr::filter(year > 2000)

women_murdered_filtered = #<<
  women_murdered_filtered |> #<<
  dplyr::mutate( #<<
    diff1 = murders_per_100000 - dplyr::lag(murders_per_100000, n = 1), #<<
    diff2 = c(NA, diff(murders_per_100000, lag = 1)) #<<
  ) #<<

print(women_murdered_filtered)
```
]
]

.pull-right-2[
.center[`r fontawesome::fa(name = "r-project", fill = miamired)` **Output**]
```{r murdered_women4_out, ref.label='murdered_women4', echo=FALSE, fig.dim=c(4.8, 4), out.height='330px', out.width='275px'}

```
]


---
# Computing the First Nonseasonal Difference

The change in the time series from one period to the next is known as the first nonseasonal difference. It can be computed as follows:  

$$DY_t = Y_t - Y_{t-1}$$

.font60[
.center[`r fontawesome::fa(name = "python", fill = miamired)`]
```{python murdered_women_py, eval=FALSE}
import pandas as pd
import numpy as np

# Reading the CSV file (Equivalent to readr::read_csv in R)
women_murdered = pd.read_csv('../../data/murdered_women_per_100000_people.csv')

# Filtering for 'United States' (Equivalent to dplyr::filter in R)
women_murdered = women_murdered[women_murdered['country'] == 'United States']

# Melting the DataFrame to make it longer (Equivalent to tidyr::pivot_longer in R)
women_murdered = pd.melt(women_murdered, id_vars=['country'], var_name='year', value_name='murders_per_100000')

# Converting 'year' column to numeric (Equivalent to as.numeric in R)
women_murdered['year'] = pd.to_numeric(women_murdered['year'], errors='coerce')

# Removing rows with NA values (Equivalent to na.omit in R)
women_murdered = women_murdered.dropna()

# Filtering for years greater than 2000 and creating a copy to avoid warnings
women_murdered_filtered = women_murdered[women_murdered['year'] > 2000].copy()

# Calculating the differences in 'murders_per_100000' (Equivalent to dplyr::mutate and diff in R)
women_murdered_filtered['diff1'] = women_murdered_filtered['murders_per_100000'].diff()
women_murdered_filtered['diff2'] = np.append(np.nan, np.diff(women_murdered_filtered['murders_per_100000']))

are_columns_identical = women_murdered_filtered['diff1'].equals(women_murdered_filtered['diff2'])
```
]




---

# Computing the First Seasonal Difference

If your data exhibits a seasonal pattern, as illustrated in [04_ts_eda.html](https://fmegahed.github.io/isa444/fall2023/class04/03_ts_eda.html), you should employ a **seasonal differencing approach**, you should subtract the difference between an observation and the previous observation from the same season. Let $m$ denote the number of seasons, e.g. $m=4$ for quarterly data. In such a case, the seasonal difference is computed as follows:  

$$DY_{t-m} = Y_t - Y_{t-m}$$


**Note:** In `r fontawesome::fa('r-project', fill = miamired)`, this can be computed by assigning the $x$ argument in the `dplyr::lag()` to $m$, or by setting the $lag$ argument in the `diff()` to $m$. In `r fontawesome::fa('python', fill = miamired)`, this can be computed by setting the 'periods' argument in the `DataFrame.diff()` method to $m$.

---

# Stablize the Variance: Power Transformations

.left-code[
.font80[
```{r jj1, eval=FALSE}
# The built-in JohnsonJohnson dataset

forecast::autoplot(JohnsonJohnson) +
  ggplot2::geom_point() + # adding points
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n=6)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  ggplot2::theme_bw()
```

]
]

.right-plot[
```{r jj1_out, ref.label='jj1', echo=FALSE}
```
]

---
count: false

# Stablize the Variance: Power Transformations

.left-code[
.font80[
```{r jj2, eval=FALSE}
# The built-in JohnsonJohnson dataset

forecast::autoplot(sqrt(JohnsonJohnson)) + #<<
  ggplot2::geom_point() + # adding points
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n=6)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  ggplot2::theme_bw()
```

]
]

.right-plot[
```{r jj2_out, ref.label='jj2', echo=FALSE}
```
]


---
count: false

# Stablize the Variance: Power Transformations

.left-code[
.font80[
```{r jj3, eval=FALSE}
# The built-in JohnsonJohnson dataset

forecast::autoplot(log(JohnsonJohnson)) + #<<
  ggplot2::geom_point() + # adding points
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n=6)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  ggplot2::theme_bw()
```

]
]

.right-plot[
```{r jj3_out, ref.label='jj3', echo=FALSE}
```
]


---

# A Note on the Log Transform

The log transformation can be computed as follows:
$$L_t = \ln{(Y_t)}$$

Note that the `log()` in both `r fontawesome::fa('r-project', fill = miamired)` and `r fontawesome::fa('python', fill = miamired)` takes the natural logarithm as its default base, i.e., would transform a variable/statistic based on the above equation.


The reverse transformation using the exponential function is:
$$e^{L_t} = e^{\ln{(Y_t})} = Y_t$$


---
count: false

# The Log Transform

- The primary purpose of the log transform is to **convert exponential growth into linear growth.**

- The transform often has the **secondary purpose of balancing the variance.**  

- Difference in logs and growth rate transformations produce similar results and interpretations (see next slides). 


---

# Stabilizing the Mean and Variance

The **first nonseasonal difference in logarithms** represents the logarithm of the ratio  
$$L_t = \ln{(\frac{Y_t}{Y_{t-1}})} = \ln{(Y_t)} - \ln{(Y_{t-1})}$$


In the absence of seasonality, the **growth rate** for a time series is given by  
$$GY_t = 100 \frac{Y_t - Y_{t-1}}{Y_{t-1}}$$


---
count: false

# Stabilizing the Mean and Variance

.left-code[
.font80[
```{r jj4, eval=FALSE}
# The built-in JohnsonJohnson dataset

forecast::autoplot(
  log(JohnsonJohnson) - log(stats::lag(JohnsonJohnson)) #<<
  ) + 
  ggplot2::geom_point() + # adding points
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n=6)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  ggplot2::theme_bw()
```

]
]

.right-plot[
```{r jj4_out, ref.label='jj4', echo=FALSE}
```
]


---
count: false

# Stabilizing the Mean and Variance

.left-code[
.font80[
```{r jj5, eval=FALSE}
# The built-in JohnsonJohnson dataset

forecast::autoplot(
  (JohnsonJohnson - stats::lag(JohnsonJohnson))/ stats::lag(JohnsonJohnson) #<<
  ) + 
  ggplot2::geom_point() + # adding points
  ggplot2::scale_x_continuous(breaks = scales::pretty_breaks(n=6)) +
  ggplot2::scale_y_continuous(breaks = scales::pretty_breaks(n = 6)) +
  ggplot2::theme_bw()
```

]
]

.right-plot[
```{r jj5_out, ref.label='jj5', echo=FALSE}
```
]


---

# A Practical Note about Growth Rates

`r countdown(minutes = 5, seconds = 0, top = 0, font_size = "2em")`

.panelset[

.panel[.panel-name[Activity]

> Over the next 5 minutes, please answer the question in each tab.


]

.panel[.panel-name[Q1]

- **Question 1:** Let us say that an investor purchased 10 stocks of \$GME, on 2021-01-29, at 325/stock. The next trading day, 2021-02-01, the GME stock closed at $225. Compute the growth rate in their portfolio worth (assuming it only has the GME stock) over this time period. 

.can-edit.key-activity4_q1[

**What is their growth rate?** .font70[(Insert below)]

  - Edit me  
  
]
]


.panel[.panel-name[Q2]

- **Question 2:** Let us say that the growth rate, $GY_t = -g$. Now let us assume that the GME stock went up by $g$ (i.e., if it went down 10%, it increased by 10% over the next trading day).  What is the value of the investor's portfolio by stock market closing on 2021-02-02? 

.can-edit.key-activity4_q2[

**What is their growth rate?** .font70[(Insert below)]

  - Edit me  
  
]

]
]


---

# A Live Demo

In this live coding session, we will perform the following transformations on the AAPL stock [YTD] in both `r fontawesome::fa('python', fill = miamired)` and `r fontawesome::fa('python', fill = miamired)`:  

  - Growth Rates  
  - Natural log
  - Log Differences  
  - $[0-1]$ Scaling  
  

```{r demo_transformations, eval = F, include=FALSE}
aapl_df = 
  tidyquant::tq_get('AAPL', from = '2023-01-01', to = Sys.Date()
    )

aapl_df = aapl_df |> 
  dplyr::group_by(symbol) |> 
  dplyr::arrange(symbol, date)

aapl_df =
  aapl_df |> 
  dplyr::mutate(
    growthRate = (adjusted - dplyr::lag(adjusted))/dplyr::lag(adjusted),
    naturalLog = log(adjusted),
    logDiffs = naturalLog - log(dplyr::lag(adjusted)),
    minAdjusted = min(adjusted),
    maxAdjusted = max(adjusted),
    scaledAdjusted = (adjusted - minAdjusted)/(maxAdjusted - minAdjusted)
  ) 
```


```{python demo_transformations_py, eval = F, include=FALSE}
import pandas as pd
import yfinance as yf
import datetime as dt
import numpy as np

# Get AAPL data from Yahoo Finance (Equivalent to tidyquant::tq_get)
aapl_df = yf.download(tickers=['AAPL'], start=dt.datetime(2023, 1, 1), end=dt.datetime.now().date())

# Reset index to make 'Date' a column and sort by date (Equivalent to dplyr::group_by and dplyr::arrange)
aapl_df.reset_index(inplace=True)
aapl_df.sort_values(['Date'], inplace=True)

# Calculating various metrics (Equivalent to dplyr::mutate)
aapl_df['growthRate'] = (aapl_df['Adj Close'] - aapl_df['Adj Close'].shift(1)) / aapl_df['Adj Close'].shift(1)
aapl_df['naturalLog'] = np.log(aapl_df['Adj Close'])
aapl_df['logDiffs'] = aapl_df['naturalLog'] - np.log(aapl_df['Adj Close'].shift(1))
aapl_df['minAdjusted'] = aapl_df['Adj Close'].min()
aapl_df['maxAdjusted'] = aapl_df['Adj Close'].max()
aapl_df['scaledAdjusted'] = (aapl_df['Adj Close'] - aapl_df['minAdjusted']) / (aapl_df['maxAdjusted'] - aapl_df['minAdjusted'])

# Show the DataFrame
aapl_df.head().transpose()

```



---

class: inverse, center, middle

# Recap

---

# Summary of Main Points

By now, you should be able to do the following:  

- Apply transformations to a time series in both `r fontawesome::fa(name = "r-project", fill = miamired)` and `r fontawesome::fa(name = "python", fill = miamired)`.  


---

# Things to Do to Prepare for Our Next Class

- Go over your notes and read through [Chapter 2.1-2.5 of our reference book](https://cdn.shopify.com/s/files/1/0859/4364/files/Part_I_POBF-_A_First_Course_in_Forecasting_1.pdf?612).   

- Complete [Assignment 03](https://miamioh.instructure.com/courses/200821/quizzes/583391) on Canvas.

