---
title: "ISA 444: Business Forecasting"
subtitle: '07: Using Basic Tools for Multiple Time-Series (Lab 01)'
author: '<br>Fadel M. Megahed, PhD <br><br> Endres Associate Professor <br> Farmer School of Business<br> Miami University<br><br> [`r icons::icon_style(icons::fontawesome("twitter"), fill = "white")` @FadelMegahed](https://twitter.com/FadelMegahed) <br> [`r icons::icon_style(icons::fontawesome("github"), fill = "white")` fmegahed](https://github.com/fmegahed/) <br> [`r icons::icon_style(icons::fontawesome("paper-plane", style = "solid"), fill = "white")` fmegahed@miamioh.edu](mailto:fmegahed@miamioh.edu)<br> [`r icons::icon_style(icons::fontawesome("question"), fill = "white")` Automated Scheduler for Office Hours](https://calendly.com/fmegahed)<br><br>'
date: "Spring 2023"
output:
  xaringan::moon_reader:
    self_contained: true
    css: [default, "../../style_files/fonts.css", "../../style_files/my-theme.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      highlightLanguage: ["r"]
      countIncrementalSlides: false
      ratio: "16:9"
header-includes:  
  - "../../style_files/header.html"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      progress = FALSE, 
                      verbose = FALSE,
                      dev = 'png',
                      dpi = 300,
                      fig.asp = 0.618,
                      fig.align = 'center',
                      out.width = '70%')

options(htmltools.dir.version = FALSE)


miamired = '#C3142D'

if(require(pacman)==FALSE) install.packages("pacman")
if(require(devtools)==FALSE) install.packages("devtools")
if(require(countdown)==FALSE) devtools::install_github("gadenbuie/countdown")
if(require(xaringanExtra)==FALSE) devtools::install_github("gadenbuie/xaringanExtra")
if(require(emo)==FALSE) devtools::install_github("hadley/emo")
if(require(icons)==FALSE) devtools::install_github("mitchelloharawild/icons")

pacman::p_load(gifski, av, gganimate, ggtext, glue, extrafont, # for animations
               emojifont, emo, RefManageR, xaringanExtra, countdown, downlit) # for slides
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
if(require(xaringanthemer) == FALSE) install.packages("xaringanthemer")
library(xaringanthemer)

style_mono_accent(base_color = "#84d6d3",
                  base_font_size = "20px")

xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)

xaringanExtra::use_xaringan_extra(c("tile_view", "animate_css", "tachyons", "panelset", "share_again", "search", "fit_screen", "editable", "clipboard"))

```


# What we Have Learned in Class So Far


`r emo::ji("check")`  Explain the differences between **cross sectional**, **time series** and **panel** datasets.

`r emo::ji("check")` Describe the **components of time series** datasets.    

`r emo::ji("check")` Access, subset, and create `ts()` objects in `r fontawesome::fa(name = "r-project")`.

`r emo::ji("check")` Examine a line chart for trends, seasonality, and cycles.  

`r emo::ji("check")`  Explain the grammar of graphics and how it can be used to create time series plots in `r fontawesome::fa('r-project', fill = miamired)`.  

`r emo::ji("check")` Create interactive time-series plots by using the [plotly](https://plotly.com/ggplot2/getting-started/) package `r fontawesome::fa('box', fill = 'gold')`.


---

# Learning Objectives for Today's Class

- Apply the basic tools for time-series analysis to many time-series.  

- Be familiar with the concept of nesting, which we will capitalize on in our next lab.


---
class: inverse, center, middle

# Lab 01: Using Basic Tools for Multiple Time-Series


---

# Step 0: A `tibble` of Stocks, Crypto and Macroeconomic Indicators

`r countdown(minutes = 8, seconds = 0, top = 0, font_size = "2em")`

```{r sample_stocks, echo=FALSE}
set.seed(2023)

'https://en.wikipedia.org/wiki/List_of_S%26P_500_companies' |> 
  rvest::read_html() |> 
  rvest::html_node('#constituents') |> 
  rvest::html_table() -> sp500_stocks

sp500_stocks_sample = sample(x = sp500_stocks$Symbol, size = 4)
```


- Use the [tidyquant](https://cran.r-project.org/web/packages/tidyquant/index.html) package `r fontawesome::fa('box', fill = 'gold')` to extract data from 2018-01-01 to 2023-02-12 for the following:  
    + **Stocks:**  `r cat(sp500_stocks_sample[1:4], sep = ', ')`  
    + **Crypto:** BTC-USD, ETH-USD,  
    + **FRED:** UNRATE, GNP, and RHORUSQ156N.
For both stocks and crypto, we will be using the `adjusted` column for our analysis and for the macroeconomic data, the time series of interest will be stored in `price`. 

- Store the results from the (multiple) calls into a single tibble containing three variables: symbol, date, price (or adjusted).  

```{r tibbled_data, echo=FALSE}

stocks_crypto = tidyquant::tq_get(
  x = c(sp500_stocks_sample[1:4], 'BTC-USD', 'ETH-USD'),
  from = '2018-01-01', to = '2023-02-12'
) |> 
  dplyr::select(symbol, date, adjusted) |> 
  dplyr::rename(price = adjusted)
  

macro = tidyquant::tq_get(
  x = c('UNRATE', 'GNP', 'RHORUSQ156N'),
  from = '2018-01-01', to = '2023-02-12',
  get = 'economic.data'
)

all_data = dplyr::bind_rows(
  stocks_crypto, macro
)

```



---

`r countdown(minutes = 8, seconds = 0, top = 0, font_size = "2em")`

# Step 1: Explore the Time-Series 

- How many observations do we have per each symbol? What conclusions can you make pertaining to the number of observations per each symbol? (e.g., freq, missing data, etc.)  

- Compute the mean absolute deviation for each time-series.  

- Plot all the different time-series.   

- Based on the three points above, write down any comments you have pertaining trends, seasonality, cycles, etc.

```{r count_obs, include=FALSE}
all_data |> 
  dplyr::group_by(symbol) |> 
  dplyr::count()
```

```{r mad_each, include=FALSE}
MAD = function(x){
  abs(x - mean(x, na.rm = T)) |> mean(na.rm = T)
}

all_data |> 
  dplyr::group_by(symbol) |> 
  dplyr::summarise(
    mad = MAD(price)
  )

```

```{r plot, include=FALSE}
all_data |> 
  ggplot2::ggplot(ggplot2::aes(x = date, y = price, group = symbol)) +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(~symbol, nrow = 3, ncol = 3, scales = 'free_y')
```


---

`r countdown(minutes = 4, seconds = 0, top = 0, font_size = "2em")`

# Step 2: Transform All Time Series

- Perform a growth rate transformation on all the time-series. Add that in a new column titled `price_chng_frac` or `price_chng_perc`. 

```{r transform, include = F}
all_data = 
  all_data |> 
  dplyr::group_by(symbol) |> 
  dplyr::mutate(
    price_chng_perc = 100*(price - dplyr::lag(price) )/ dplyr::lag(price)
  )
```




---

`r countdown(minutes = 8, seconds = 0, top = 0, font_size = "2em")`

# Step3: Compute Naive Forecast for Each TS

For each time-series, compute the nonseasonal naive forecast (for both the original and the transformed ts). Then, compute the ME, MAD, and MAPE for each time-series . 

```{r naive, include=FALSE}
all_data = 
  all_data |> 
  dplyr::mutate(
    naive_o = dplyr::lag(price),
    naive_t = dplyr::lag(price_chng_perc),
    # errors
    error_o = price - naive_o,
    error_t = price_chng_perc - naive_t,
    # percent errors
    pe_o = error_o/price,
    pe_t = error_t/price_chng_perc
  )

all_data |> 
  dplyr::summarise(
    me_o = mean(error_o, na.rm = T),
    mad_o = MAD(error_o),
    mape_o = mean(abs(pe_o), na.rm = T),
    
    # transformed
    me_t = mean(error_t, na.rm = T),
    mad_t = MAD(error_t),
    mape_t = mean(abs(pe_t), na.rm = T),
  )
```


---

# Let us Talk about Nesting

- See in-class code, and refer to [nest.html](https://tidyr.tidyverse.org/articles/nest.html) for more details about this concept.

```{r nested_data, include=FALSE}

all_data = dplyr::bind_rows(
  stocks_crypto, macro
) |> 
  dplyr::group_by(symbol)

nested_data = 
  tidyr::nest(all_data) |>
  dplyr::mutate(
    date = purrr::map(.x = data, .f = magrittr::extract2, 'date'),
    price = purrr::map(.x = data, .f = magrittr::extract2, 'price'),
    
    naive_fit = purrr::map(
      .x = price, .f = dplyr::lag
    ),
    
    acc_metrics = purrr::map2(
      .x = naive_fit, .y = price,
      .f = forecast::accuracy
    ),
    
    me = purrr::map_dbl(.x = acc_metrics, .f = magrittr::extract2, c(1)),
    mae = purrr::map_dbl(.x = acc_metrics, .f = magrittr::extract2, c(3)),
    mape = purrr::map_dbl(.x = acc_metrics, .f = magrittr::extract2, c(5))
  )
  


```




---

class: inverse, center, middle

# Recap

---

# Summary of Main Points

By now, you should be able to do the following:  

- Apply the basic tools for time-series analysis to many time-series.  

- Be familiar with the concept of nesting, which we will capitalize on in our next lab.


---

# Things to Do to Prepare for Our Next Class


- Complete [Assignment 06](https://miamioh.instructure.com/courses/188655/assignments/2380005) on Canvas.

