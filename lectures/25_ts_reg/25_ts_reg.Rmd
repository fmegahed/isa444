---
title: "ISA 444: Business Forecasting"
subtitle: '25: Time Series Regression'
author: '<br>Fadel M. Megahed, PhD <br><br> Endres Associate Professor <br> Farmer School of Business<br> Miami University<br><br> [`r icons::icon_style(icons::fontawesome("twitter"), fill = "white")` @FadelMegahed](https://twitter.com/FadelMegahed) <br> [`r icons::icon_style(icons::fontawesome("github"), fill = "white")` fmegahed](https://github.com/fmegahed/) <br> [`r icons::icon_style(icons::fontawesome("paper-plane", style = "solid"), fill = "white")` fmegahed@miamioh.edu](mailto:fmegahed@miamioh.edu)<br> [`r icons::icon_style(icons::fontawesome("question"), fill = "white")` Automated Scheduler for Office Hours](https://calendly.com/fmegahed)<br><br>'
date: "Spring 2023"
output:
  xaringan::moon_reader:
    self_contained: true
    css: [default, "../../style_files/fonts.css", "../../style_files/my-theme.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      highlightLanguage: ["r"]
      countIncrementalSlides: false
      ratio: "16:9"
header-includes:  
  - "../../style_files/header.html"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      progress = FALSE, 
                      verbose = FALSE,
                      dev = 'png',
                      dpi = 300,
                      fig.asp = 0.618,
                      fig.align = 'center',
                      out.width = '70%')

options(htmltools.dir.version = FALSE)


miamired = '#C3142D'

if(require(pacman)==FALSE) install.packages("pacman")
if(require(devtools)==FALSE) install.packages("devtools")
if(require(countdown)==FALSE) devtools::install_github("gadenbuie/countdown")
if(require(xaringanExtra)==FALSE) devtools::install_github("gadenbuie/xaringanExtra")
if(require(emo)==FALSE) devtools::install_github("hadley/emo")
if(require(icons)==FALSE) devtools::install_github("mitchelloharawild/icons")

pacman::p_load(gifski, av, gganimate, ggtext, glue, extrafont, # for animations
               emojifont, emo, RefManageR, xaringanExtra, countdown, downlit) # for slides
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
if(require(xaringanthemer) == FALSE) install.packages("xaringanthemer")
library(xaringanthemer)

style_mono_accent(base_color = "#84d6d3",
                  base_font_size = "20px")

xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         
  mute_unhighlighted_code = TRUE  
)

xaringanExtra::use_xaringan_extra(c("tile_view", "animate_css", "tachyons", "panelset", "share_again", "search", "fit_screen", "editable", "clipboard"))

```


# Quick Refresher from Last Class

`r emo::ji("check")` Explain the simple and multiple linear regression models and interpret the parameters.     

`r emo::ji("check")` Interpret the sample linear regression coefficients in the language of the problem.    

`r emo::ji("check")` Use a simple linear regression model for trend adjustment (time-series data).    


---

# Overview of Univariate Forecasting Methods

```{r read_ts_taxonomy, echo=FALSE, out.width='100%', fig.alt="A 10,000 foot view of univariate forecasting techniques", fig.align='center', fig.cap='A 10,000 foot view of forecasting techniques'}
knitr::include_graphics("../../figures/forecasting_methods1.png")
```

.footnote[
<html>
<hr>
</html>

**Notes:** My (incomplete) classification of **univariate** forecasting techniques, i.e., they exclude popular approaches used in multivariate time series forecasting.  
]

---


# Learning Objectives for Today's Class

- Use a simple linear regression model for trend adjustment (time-series data).   

- Interpret regression diagnostic plots.  

- Create prediction intervals for individual values of the response variable.  


---
class: inverse, center, middle

# Using Simple Linear Regression Model for Trend Adjustment (with Time Series Data)


---

# Continuing our Example from Last Class

.pull-left[

.font80[
```{r jj7, eval=FALSE}
jj = astsa::jj

# Step 1: Plot the ts data (saved to object to not print)
p = forecast::autoplot(jj) + 
  ggplot2::theme_bw() + 
  ggplot2::geom_point(size = 1) 

# stabilizing the variance
log_jj = log(jj) 

# Step 1b: Our updated plot
p2 = forecast::autoplot(log_jj) + 
  ggplot2::theme_bw() + 
  ggplot2::geom_point(size = 1)

# Step 2: Extract time
year = time(log_jj)

# Step 3: Fit the regression model
reg_model = lm(log_jj ~ year) 

summary(reg_model) # prints top right  

anova(reg_model) # prints bottom right
```

]

]

.pull-right[

.font70[
```{r jj7_out, ref.label = 'jj7', out.width = '100%', echo=FALSE, fig.dim= c(4.4, 4.4)}
```
]

]


---

# Continuing our Example from Last Class

`r countdown(minutes = 5, seconds = 0, top = 0, font_size = "2em")`

.center[.font90[**What would be our forecast values log EPS for 1981?**]]


.pull-left[
.font80[

.center[**Manual Calculations:**]

Recall that our regression equation from `summary(reg_model)` was: $$\text{log_jj} = -327.5 + 0.1668\times\text{year}$$

.can-edit.key-activity1[

- For Q1, my predicted log EPS = ...   

- For Q2, my predicted log EPS = ...   

- For Q3, my predicted log EPS = ...   

- For Q4, my predicted log EPS = ...   

]

]
]

.pull-right[

.center[.font80[**R Functions:**]]

.font80[

```{r jj8}
# Approach (a):
pred1981a = predict( #<<
  object = reg_model, #<<
  newdata = #<<
    data.frame(year = c(1981, 1981.25, 1981.5, 1981.75)) #<<
) #<<

# Approach (b): I prefer this approach
pred1981b = forecast::forecast( #<<
  object = reg_model, #<<
  newdata = #<<
    data.frame(year = c(1981, 1981.25, 1981.5, 1981.75)) #<<
) #<<

```
]

.font80[
**Why is approach (b) slightly better? (ignoring the need to load an extra package)**

.can-edit.key-activity2[

*Approach (b) is better because:*

- ...   

]

]
]


---

# `forecast::tslm()` vs. `lm()`

Let us examine and contrast the output from the `forecast::tslm()`, compared to what we obtained in Slide 6.  There are **3** reasons for which I tend to prefer the `forecast::tslm()` (if you are willing to ignore the need to load an extra package): 

.can-edit.key-activity3[

**Please fill after we go through the example:**

- ...   

- ...   

- ...   

]


---

# Our Example with `forecast::tslm()`


.pull-left[
.font80[
```{r jj9, eval=FALSE}
model_tslm = #<<
  forecast::tslm(log_jj ~ trend) #<<

summary(model_tslm)
```

.center[**From the output, what are the intercept and slope for year? Interpret their values.**]

.can-edit.key-activity4[

**Slope and intercept from `forecast::tslm()`:**

- Intercept: ...   

- Interpretation: ...   

- Slope: ...   

- Interpretation: ...   

- Difference from `lm()` output: ...

]

]
]


.pull-right[
.font80[
```{r jj9_out, ref.label = 'jj9', out.width = '100%', echo=FALSE, fig.dim= c(4.4, 4.4)}

```
]
]


---
count: false

# Our Example with `forecast::tslm()`

.pull-left[
.font80[
```{r jj10, eval=FALSE}
model_tslm = 
  forecast::tslm(log_jj ~ trend) 

pred_1981_tslm = 
  forecast::forecast( #<<
    model_tslm, h = 4, level = 95 #<<
    ) #<<

# Printing the point estimates
pred_1981_tslm$mean #<<

# TS Plot w/ forecast, fitted values, &
# 95% PI ( defined in forecast() )
forecast::autoplot(pred_1981_tslm) + #<<
  forecast::autolayer( 
    fitted(pred_1981_tslm) 
    ) +
  ggplot2::theme(
    legend.position = 'none'
    )
```
]
]

.pull-right[
.font80[
```{r j10_out, ref.label = 'jj10', out.width = '90%', echo=FALSE, fig.dim= c(4.1, 4.1)}

```
]
]


---

class: inverse, center, middle

# Regression Diagnostic Plots

---

# Regression Diagnostic Plots

.font60[
```{r resplot}
resplot <- function(res, fit, ncol = 2, nrow = 3, freq = NULL){
  ggplot2::theme_set(ggplot2::theme_bw()) # setting the theme for all ggplots to be black and white
  
  df = data.frame(res = res, fit = fit) # creating a df of residuals and fitted values
  
  # Plot 1: QQ Plot for the residuals
  qq = ggplot2::ggplot(df, ggplot2::aes(sample = res)) + 
    ggplot2::stat_qq() +  ggplot2::stat_qq_line() +  ggplot2::labs(x = "Theoretical Values", y = "Sample")
  
  # Plot 2: Scatter Plot of Residuals Vs. Fitted Values
  scatter = ggplot2::ggplot(df, ggplot2::aes(x = fit, y = res)) + 
    ggplot2::geom_point() + ggplot2::geom_hline(yintercept = 0) +
    ggplot2::labs(x = "Fitted Values", y = "Residuals")
  
  # Plot 3: Histogram of Residuals with Density Plot
  histogram = ggplot2::ggplot(df, aes(x = res)) + 
    ggplot2::geom_histogram(bins = 15) + ggplot2::geom_density(alpha = 0.2, fill = "red") +
    ggplot2::geom_vline(ggplot2::aes(xintercept= mean(res)), color="red", linetype="dashed", size=1) + ggplot2::labs(x = "Residuals", y = "Count")
  
  # Plot 4: Time Order Plot of Residuals
  if(is.numeric(freq)){
    colorFactor = as.factor( as.numeric(row.names(df)) %% freq ) # coloring based on the modulus operation
    timeOrder = ggplot2::ggplot(df, ggplot2::aes(x = as.numeric(row.names(df)), y = res) ) +
      ggplot2::geom_line() + ggplot2::geom_point(aes(color = colorFactor)) + ggplot2::geom_hline(yintercept = 0) + 
      ggplot2::labs(x = "Observation Order", y = "Residuals") + ggplot2::theme(legend.position = "none")
  }else{
    timeOrder = ggplot2::ggplot(df, ggplot2::aes(x = as.numeric(row.names(df)), y = res)) +
      ggplot2::geom_line() + ggplot2::geom_point() + ggplot2::geom_hline(yintercept = 0) + 
      ggplot2::labs(x = "Observation Order", y = "Residuals") 
  }
  
  # Plot 5: ACF Plot of Residuals
  acfPlot = forecast::ggAcf(res) + ggplot2::labs(title = "")
  
  # Plot 6: ACF Plot of Residuals
  pacfPlot = forecast::ggPacf(res) + ggplot2::labs(title = "")
 
  # Putting all 6 figures together
  ggpubr::ggarrange(qq, scatter, histogram, timeOrder, acfPlot, pacfPlot, ncol = ncol, nrow = nrow)
}

```
]


---

# Applying the `resPlot()`

.font80[
```{r jj11, out.width='60%'}
residuals_tslm = model_tslm$residuals
fitted_tslm = model_tslm$fitted.values

resplot(res = residuals_tslm, fit = fitted_tslm, freq = 4)
```
]

---

# Insights from the `resPlot()`

- Assumption behind using the forecast function is that we have a model that fits well to our data.  

- The diagnostics on the regression model confirmed that we do not have an excellent model since our residuals are not iid. Specifically, the:  
  + The residuals **vary in magnitude as a function of the fitted values**.  
  + The residuals show a **seasonal pattern**, where Q2 residuals are typically large and Q4 residuals are typically small.  
  - The ACF and PACF show a **seasonal pattern in the residuals** â€“ likely need to fit an AR model.  



---
class: inverse, center, middle

# Recap

---

# Summary of Main Points

By now, you should be able to do the following:   

- Use a simple linear regression model for trend adjustment (time-series data).   

- Interpret regression diagnostic plots.  

- Create prediction intervals for individual values of the response variable.  


---

# Things to Do to Prepare for Next Class

- Go through the slides, examples and make sure you have a good understanding of what we have covered.  

- Read Chapter $7$ in our reference book [Principles of Business Forecasting](https://cdn.shopify.com/s/files/1/0859/4364/files/Part_I_POBF-_A_First_Course_in_Forecasting_1.pdf?612).  
